        const parsedResult = JSON.parse(cleanResult);
        if (parsedResult.suggestion?.date) {
          handleNewFollowUpDate(new Date(parsedResult.suggestion.date).getTime());
        }
      } catch (error) {
        console.log("Failed to parse AI response:", error);
      }
    } catch (error) {
      toast.error("Failed to generate follow-up suggestion");
      console.error(error);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleDelete = async () => {
    if (!user || !lead) return;
    try {
      await deleteLead({ leadId: lead._id, adminId: user._id });
      toast.success("Lead deleted successfully");
      onClose();
    } catch (error) {
      toast.error("Failed to delete lead");
      console.error(error);
    }
  };

  const handleSetFollowUpDate = (date: string) => {
    if (date) {
      handleNewFollowUpDate(new Date(date).getTime());
      setTempFollowUpDate("");
    } else {
      toast.error("Please select a date");
    }
  };

  if (lead === undefined) {
    return <div className="flex-1 flex items-center justify-center h-full">Loading...</div>;
  }

  if (lead === null) {
    return <div className="flex-1 flex items-center justify-center h-full">Lead not found</div>;
  }

  const getMinDateTime = () => {
    const now = new Date();
    now.setMinutes(now.getMinutes() + 1);
    return now.toISOString().slice(0, 16);
  };

  const getMaxDateTime = () => {
    const maxDate = new Date();
    maxDate.setDate(maxDate.getDate() + 31);
    return maxDate.toISOString().slice(0, 16);
  };

  const formatFollowUpDate = (timestamp?: number) => {
    if (!timestamp) return "Not set";
    return new Date(timestamp).toLocaleString();
  };

  return (
    <div className="flex-1 flex flex-col overflow-hidden bg-card border rounded-lg shadow-sm h-full">
      <LeadDetailsHeader
        lead={lead}
        isEditing={isEditing}
        isAdmin={user?.role === "admin"}
        onClose={onClose}
        onStartEditing={startEditing}
        onCancelEditing={cancelEditing}
        onSaveEdits={saveEdits}
        onStatusChange={handleStatusChange}
        onTypeChange={handleTypeChange}
        onTagsChange={handleTagsChange}
        onDelete={handleDelete}
        onShowAiDialog={() => setShowAiDialog(true)}
      />

      <div className="flex-1 overflow-y-auto p-6">
        <LeadInfo 
          lead={lead} 
          isEditing={isEditing} 
          editedLead={editedLead} 
          setEditedLead={setEditedLead} 
        />

        <div className="mb-8">
          <h3 className="font-semibold mb-2 flex items-center gap-2 text-primary">
            <Calendar className="h-4 w-4" /> Follow-up Date
            {lead.assignedTo && <span className="text-xs text-red-500 font-normal">(Required)</span>}
          </h3>
          {isEditing ? (
            <div className="space-y-2">
              <Input 
                type="datetime-local"
                value={editedLead.nextFollowUpDate ? new Date(editedLead.nextFollowUpDate).toISOString().slice(0, 16) : ""}
                onChange={(e) => setEditedLead({ ...editedLead, nextFollowUpDate: new Date(e.target.value).getTime() })}
                min={getMinDateTime()}
                max={getMaxDateTime()}
                className="max-w-md"
              />
              <p className="text-xs text-muted-foreground">
                Must be between now and 31 days in the future
              </p>
            </div>
          ) : (
            <div className={`bg-muted/30 p-4 rounded-md text-sm border ${
              lead.nextFollowUpDate && lead.nextFollowUpDate < Date.now() 
                ? 'border-red-500 bg-red-50' 
                : 'border-border'
            }`}>
              {formatFollowUpDate(lead.nextFollowUpDate)}
              {lead.nextFollowUpDate && lead.nextFollowUpDate < Date.now() && (
                <span className="ml-2 text-red-600 font-bold">âš  Overdue</span>
              )}
            </div>
          )}
        </div>

        <div className="mb-8">
          <h3 className="font-semibold mb-2 text-primary">Message</h3>
          {isEditing ? (
            <Textarea 
              value={editedLead.message || ""} 
              onChange={(e) => setEditedLead({ ...editedLead, message: e.target.value })}
              className="min-h-[100px]"
            />
          ) : (
            <div className="bg-muted/30 p-4 rounded-md text-sm border border-border">
              {lead.message || <span className="text-muted-foreground italic">No message content.</span>}
            </div>
          )}
        </div>

        <LeadActivity 
          comments={comments || []} 
          newComment={newComment} 
          setNewComment={setNewComment} 
          onAddComment={handleAddComment} 
        />
      </div>

      <LeadDetailsFollowUpDialogs
        showFollowUpCheck={showFollowUpCheck}
        showNewFollowUpDialog={showNewFollowUpDialog}
        tempFollowUpDate={tempFollowUpDate}
        isTestMode={isTestMode}
        onFollowUpDone={handleFollowUpDone}
        onFollowUpNotDone={handleFollowUpNotDone}
        onSetFollowUpDate={handleSetFollowUpDate}
        onTempDateChange={setTempFollowUpDate}
        onCloseNewFollowUp={() => setShowNewFollowUpDialog(false)}
        getMinDateTime={getMinDateTime}
        getMaxDateTime={getMaxDateTime}
      />

      <LeadDetailsAiDialog
        isOpen={showAiDialog}
        onClose={() => setShowAiDialog(false)}
        isAnalyzing={isAnalyzing}
        aiAnalysis={aiAnalysis}
        onAnalyzeLead={handleAiAnalysis}
        onSuggestFollowUp={handleAiFollowUpSuggestion}
      />
    </div>
  );
}
